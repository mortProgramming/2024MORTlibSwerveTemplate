package frc.robot.library.Swerve;

import edu.wpi.first.math.controller.PIDController;
import edu.wpi.first.math.geometry.Rotation2d;
import edu.wpi.first.math.kinematics.SwerveModuleState;

import frc.robot.library.Hardware.ctre.CTREUtility;
import frc.robot.library.Hardware.ctre.CTREUtility.Falcon500;
import frc.robot.library.Hardware.ctre.CTREUtility.Krakenx60;
import frc.robot.library.Hardware.rev.RevUtility;
import frc.robot.library.Hardware.rev.RevUtility.NEO;
import frc.robot.library.Hardware.rev.RevUtility.NEO550;
import frc.robot.library.Hardware.Motor;
import frc.robot.library.Hardware.MotorIntf;
import frc.robot.library.Hardware.MotorTypeEnum;
import frc.robot.library.Hardware.Encoder;
import frc.robot.library.Hardware.EncoderIntf;
import frc.robot.library.Hardware.EncoderTypeEnum;
import static frc.robot.library.Swerve.Constants.*;

public class SwerveModule {

    public int driveMotorID;
    public int steerMotorID;
    public int encoderID;

    public MotorTypeEnum driveMotorType;
    public MotorTypeEnum steerMotorType;
    public EncoderTypeEnum encoderType;
    public ModuleTypeEnum moduleType;

    public MotorIntf driveMotor;
    public MotorIntf steerMotor;
    public EncoderIntf encoder;

    public double maxSpeed;
    public double maxVoltage;
    public double offset;

    public SwerveModuleState state;

    public SwerveModule(MotorTypeEnum driveMotorType, int driveMotorID, 
            MotorTypeEnum steerMotorType, int steerMotorID, 
            EncoderTypeEnum encoderType, int encoderID,
            ModuleTypeEnum moduleType
        ) {
        this.driveMotorID = driveMotorID;
        this.driveMotorID = driveMotorID;
        this.encoderID = encoderID;

        this.driveMotorType = driveMotorType;
        this.steerMotorType = steerMotorType;
        this.encoderType = encoderType;
        this.moduleType = moduleType;

        this.driveMotor = new Motor(driveMotorType, driveMotorID);
        this.steerMotor = new Motor(steerMotorType, steerMotorID);
        this.encoder = new Encoder(encoderType, encoderID);

        this.maxSpeed = Math.PI / 60;
        this.maxVoltage = 12;
        this.offset = 0;

        switch(driveMotorType) {
            case NEO:
                this.maxSpeed = this.maxSpeed * NEO.MAX_RPM;
                break;
            case NEO550:
                this.maxSpeed = this.maxSpeed * NEO550.MAX_RPM;
                break;
            case FALCON:
                this.maxSpeed = this.maxSpeed * Falcon500.MAX_RPM;
                break;
            case KRAKEN:
                this.maxSpeed = this.maxSpeed * Krakenx60.MAX_RPM;
                break;
        }

        switch (steerMotorType) {
            case NEO:
                this.steerMotor.setPIDValues(
                    NEO.SWERVE_STEER_KP, 
                    NEO.SWERVE_STEER_KI, 
                    NEO.SWERVE_STEER_KD
                );
                break;
            case NEO550:
                this.steerMotor.setPIDValues(
                    NEO550.SWERVE_STEER_KP, 
                    NEO550.SWERVE_STEER_KI, 
                    NEO550.SWERVE_STEER_KD
                );
                break;
            case FALCON:
                this.steerMotor.setPIDValues(
                    Falcon500.SWERVE_STEER_KP, 
                    Falcon500.SWERVE_STEER_KI, 
                    Falcon500.SWERVE_STEER_KD
                );
                break;
            case KRAKEN:
                this.steerMotor.setPIDValues(
                    Krakenx60.SWERVE_STEER_KP, 
                    Krakenx60.SWERVE_STEER_KI, 
                    Krakenx60.SWERVE_STEER_KD
                );
                break;
        }

        switch (moduleType) {
            case MK4i:
                this.maxSpeed = this.maxSpeed * MK4i.WHEEL_DIAMETER * MK4i.DRIVE_REDUCTION;
        }
    }

    public void setPosition(Rotation2d setpoint) {
        this.setPositionD(setpoint.getDegrees());
    }

    public void setPositionD(double setpoint) {
        this.steerMotor.setPositionD((this.encoder.getPositionD() - offset), setpoint);
    }

    public void setDrivePercent(double percent) {
        this.driveMotor.setPercent(percent);
    }

    public void setDriveVoltage(double voltage) {
        this.driveMotor.setVoltage(voltage);
    }

    public void setDriveSpeedMeters(double speedMeters) {
        this.driveMotor.setVoltage((speedMeters / this.maxSpeed) * this.maxVoltage);
    }

    public void setModuleState(SwerveModuleState state) {
        this.state = state;

        setDriveSpeedMeters(state.speedMetersPerSecond);
        setPosition(state.angle);
    }

    public void setMaxVoltage(double maxVoltage) {
        this.maxVoltage = maxVoltage;
    }

    public void setOffset(double offset) {
        this.offset = offset;
    }



    public double getEncoderPositionD() {
        return this.encoder.getPositionD() - offset;
    }

    public double getDriveVelocityD() {
        return this.driveMotor.getVelocityD();
    }

    public double getMaxSpeed() {
        return this.maxSpeed;
    }

    public double getMaxVoltage() {
        return this.maxVoltage;
    }

    public SwerveModuleState getModuleState() {
        return this.state;
    }



    public MotorIntf getDriveMotor() {
        return this.driveMotor;
    }
    
    public MotorIntf getSteerMotor() {
        return this.steerMotor;
    }

    public EncoderIntf getEncoder() {
        return this.encoder;
    }



    public MotorTypeEnum getDriveMotorType() {
        return this.driveMotorType;
    }
    
    public MotorTypeEnum getSteerMotorType() {
        return this.steerMotorType;
    }

    public EncoderTypeEnum getEncoderType() {
        return this.encoderType;
    }

    public ModuleTypeEnum getModuleType() {
        return this.moduleType;
    }

}